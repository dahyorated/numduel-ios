<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="NUM DUEL">
<meta name="theme-color" content="#06080f">
<title>NUM●DUEL</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700;800&family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}
:root{
  --bg:#06080f;--s1:#0f1320;--s2:#161c2e;--s3:#1e2640;
  --bdr:#263354;--acc:#f59e0b;--acc2:#b45309;
  --ok:#10b981;--warn:#f59e0b;--bad:#ef4444;
  --tx:#e8ecf4;--tx2:#5e6e8a;
  --p1:#818cf8;--p2:#f472b6;
  --safe-top:env(safe-area-inset-top);
  --safe-bottom:env(safe-area-inset-bottom);
  --safe-left:env(safe-area-inset-left);
  --safe-right:env(safe-area-inset-right);
}
html{background:var(--bg)}
body{background:var(--bg);color:var(--tx);font-family:'DM Sans',system-ui,-apple-system,sans-serif;min-height:100dvh;overflow-x:hidden;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
.mono{font-family:'JetBrains Mono',monospace}

@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:.3}50%{opacity:1}}
@keyframes pop{0%{transform:scale(.85);opacity:0}100%{transform:scale(1);opacity:1}}
@keyframes glow{0%,100%{box-shadow:0 0 6px var(--p2)}50%{box-shadow:0 0 20px var(--p2)}}
@keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
@keyframes gradientMove{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
@keyframes float{0%,100%{transform:translateY(0) rotate(0deg)}25%{transform:translateY(-18px) rotate(5deg)}50%{transform:translateY(-8px) rotate(-3deg)}75%{transform:translateY(-22px) rotate(3deg)}}
@keyframes floatSlow{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
@keyframes titleGlow{0%,100%{text-shadow:0 0 20px rgba(129,140,248,.2),0 0 40px rgba(244,114,182,.1)}50%{text-shadow:0 0 30px rgba(129,140,248,.4),0 0 60px rgba(244,114,182,.2)}}
@keyframes borderGlow{0%,100%{border-color:var(--bdr);box-shadow:0 0 0 transparent}50%{border-color:#818cf844;box-shadow:0 0 30px rgba(129,140,248,.06)}}
@keyframes dotPulse{0%,100%{transform:scale(1);opacity:.6}50%{transform:scale(1.3);opacity:1}}
@keyframes orbitSpin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
@keyframes staggerIn{from{opacity:0;transform:translateY(20px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}
.fade-up{animation:fadeUp .35s ease both}
.pop{animation:pop .3s cubic-bezier(.34,1.56,.64,1) both}
.slide-up{animation:slideUp .4s cubic-bezier(.25,.46,.45,.94) both}
.stagger-1{animation:staggerIn .5s cubic-bezier(.25,.46,.45,.94) .05s both}
.stagger-2{animation:staggerIn .5s cubic-bezier(.25,.46,.45,.94) .15s both}
.stagger-3{animation:staggerIn .5s cubic-bezier(.25,.46,.45,.94) .25s both}

/* Home screen background */
.home-bg{position:fixed;inset:0;overflow:hidden;pointer-events:none;z-index:0}
.home-bg::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(ellipse at 30% 20%,rgba(129,140,248,.07) 0%,transparent 50%),radial-gradient(ellipse at 70% 80%,rgba(244,114,182,.06) 0%,transparent 50%),radial-gradient(ellipse at 50% 50%,rgba(245,158,11,.04) 0%,transparent 40%);animation:gradientMove 12s ease-in-out infinite}
.float-num{position:absolute;font-family:'JetBrains Mono',monospace;font-weight:800;color:rgba(129,140,248,.06);pointer-events:none;user-select:none}

/* Home title */
.home-title{font-size:clamp(36px,10vw,52px);font-weight:900;letter-spacing:-2px;animation:titleGlow 4s ease-in-out infinite}
.home-title .dot{display:inline-block;animation:dotPulse 2s ease-in-out infinite;color:var(--acc)}
.home-subtitle{color:var(--tx2);font-size:clamp(13px,3.5vw,16px);margin-top:8px;opacity:0;animation:fadeUp .6s ease .3s both}

/* Orbit decoration around title */
.title-wrap{position:relative;display:inline-block}
.orbit{position:absolute;inset:-30px;border-radius:50%;border:1px dashed rgba(129,140,248,.1);animation:orbitSpin 20s linear infinite;pointer-events:none}
.orbit::after{content:'';position:absolute;top:0;left:50%;width:6px;height:6px;border-radius:50%;background:var(--p1);transform:translate(-50%,-50%);box-shadow:0 0 8px var(--p1)}
.orbit-2{position:absolute;inset:-50px;border-radius:50%;border:1px dashed rgba(244,114,182,.08);animation:orbitSpin 30s linear reverse infinite;pointer-events:none}
.orbit-2::after{content:'';position:absolute;bottom:0;left:50%;width:4px;height:4px;border-radius:50%;background:var(--p2);transform:translate(-50%,50%);box-shadow:0 0 6px var(--p2)}

/* Enhanced card for home */
.card-home{animation:borderGlow 4s ease-in-out infinite;transition:transform .3s,box-shadow .3s}
.card-home:hover{box-shadow:0 8px 40px rgba(0,0,0,.3)}

/* Enhanced buttons for home */
.btn-go:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 6px 24px #818cf844}

/* How to play section */
.how-to-play{position:relative;padding:16px 20px;background:var(--s1);border:1px solid var(--bdr);border-radius:14px;margin-top:24px;max-width:440px;width:100%;opacity:0;animation:staggerIn .5s ease .4s both}
.how-to-play::before{content:'';position:absolute;inset:-1px;border-radius:14px;padding:1px;background:linear-gradient(135deg,rgba(129,140,248,.15),transparent,rgba(244,114,182,.15));-webkit-mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none}

.screen{min-height:100dvh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px 16px;padding-top:calc(20px + var(--safe-top));padding-bottom:calc(20px + var(--safe-bottom))}
.card{background:var(--s1);border:1px solid var(--bdr);border-radius:20px;padding:28px 24px;width:100%;max-width:440px}

.inp{width:100%;padding:14px 16px;font-size:16px;background:var(--s2);border:1.5px solid var(--bdr);border-radius:12px;color:var(--tx);outline:none;font-family:inherit;transition:border .2s,box-shadow .2s}
.inp:focus{border-color:var(--acc);box-shadow:0 0 0 3px #f59e0b22}
.inp::placeholder{color:var(--tx2)}
.dig-inp{font-family:'JetBrains Mono',monospace;font-size:28px;letter-spacing:14px;text-align:center;padding:16px 20px}

.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 24px;border-radius:14px;border:none;font-size:15px;font-weight:700;font-family:inherit;cursor:pointer;transition:all .15s cubic-bezier(.25,.46,.45,.94);width:100%;position:relative;overflow:hidden}
.btn:active{transform:scale(.96)}.btn:disabled{opacity:.35;cursor:default;transform:none}
.btn-go{background:linear-gradient(135deg,var(--p1),var(--p2),var(--p1));background-size:200% 200%;animation:gradientMove 3s ease infinite;color:#fff;box-shadow:0 4px 16px #818cf833;transition:all .2s cubic-bezier(.25,.46,.45,.94)}
.btn-go:active{box-shadow:0 2px 8px #818cf844}
.btn-acc{background:var(--acc);color:#000;box-shadow:0 4px 12px #f59e0b33}
.btn-out{background:0 0;border:2px solid var(--bdr);color:var(--tx2)}
.btn-out:hover{border-color:var(--acc);color:var(--acc)}
.btn-sm{padding:9px 14px;font-size:13px;width:auto;border-radius:10px}
.btn-ok{background:#10b98118;border:1.5px solid var(--ok);color:var(--ok)}
.btn-bad{background:#ef444418;border:1.5px solid var(--bad);color:var(--bad)}

.chips{display:flex;gap:8px}
.chip{flex:1;padding:14px 0;border-radius:12px;font-size:20px;font-weight:800;border:2px solid var(--bdr);background:0 0;color:var(--tx2);cursor:pointer;transition:all .2s cubic-bezier(.25,.46,.45,.94);font-family:'JetBrains Mono',monospace}
.chip:active{transform:scale(.95)}
.chip.on{border-color:var(--acc);background:#b4530920;color:var(--acc);box-shadow:0 0 16px #f59e0b33;transform:scale(1.04)}

.code{font-family:'JetBrains Mono',monospace;font-size:38px;font-weight:800;letter-spacing:10px;color:var(--acc);text-align:center;padding:18px;background:#b4530920;border:2px dashed #f59e0b44;border-radius:16px;cursor:pointer;user-select:all;transition:all .2s}
.code:active{transform:scale(.97);background:#b4530930}

.topbar{background:var(--s1);border-bottom:1px solid var(--bdr);padding:10px 16px;padding-top:calc(10px + var(--safe-top));display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);background:rgba(15,19,32,.85)}
.my-secret{font-family:'JetBrains Mono',monospace;font-size:24px;font-weight:800;letter-spacing:8px;color:var(--acc)}
.my-secret-lbl{font-size:10px;color:var(--tx2);text-transform:uppercase;letter-spacing:1px;font-weight:700}

.status{padding:10px 16px;text-align:center;font-size:14px;font-weight:700;position:sticky;top:calc(57px + var(--safe-top));z-index:99}
.status.go{background:#818cf822;border-bottom:2px solid var(--p1);color:var(--p1)}
.status.wait{background:var(--s2);border-bottom:1px solid var(--bdr);color:var(--tx2)}
.status.fb{background:#f472b622;border-bottom:2px solid var(--p2);color:var(--p2);animation:glow 2s ease infinite}
.status.done{background:#10b98122;border-bottom:2px solid var(--ok);color:var(--ok)}

.tabs{display:flex;background:var(--s1);border-bottom:1px solid var(--bdr)}
.tab{flex:1;padding:12px;text-align:center;font-size:13px;font-weight:700;cursor:pointer;border:none;background:0 0;color:var(--tx2);border-bottom:3px solid transparent;transition:all .15s;font-family:inherit;position:relative}
.tab:active{background:var(--s2)}
.tab.on{color:var(--p1);border-bottom-color:var(--p1)}
.tab.on:last-child{color:var(--p2);border-bottom-color:var(--p2)}
.tab.tab-chat.on{color:var(--acc);border-bottom-color:var(--acc)}
.tab .dot{position:absolute;top:8px;right:calc(50% - 40px);width:8px;height:8px;border-radius:50%;background:var(--bad);animation:pulse 1s ease infinite}

.chat-list{padding:8px 16px;flex:1;overflow-y:auto;-ms-overflow-style:none;scrollbar-width:none;-webkit-overflow-scrolling:touch;display:flex;flex-direction:column;gap:8px}
.chat-list::-webkit-scrollbar{display:none}
.chat-msg{max-width:85%;padding:10px 14px;border-radius:14px;font-size:14px;line-height:1.4;word-break:break-word;animation:fadeUp .25s ease both}
.chat-msg.mine{align-self:flex-end;background:var(--p1);color:#fff;border-bottom-right-radius:4px}
.chat-msg.theirs{align-self:flex-start;background:var(--s3);border:1px solid var(--bdr);color:var(--tx);border-bottom-left-radius:4px}
.chat-msg .chat-meta{font-size:10px;opacity:.85;margin-top:4px}
.chat-inrow{display:flex;gap:8px;align-items:center;padding:8px 0}
.chat-inrow .inp{flex:1;padding:12px 14px;font-size:15px;min-height:0}
.chat-inrow .btn{width:auto;flex-shrink:0;padding:12px 18px}

.glist{padding:8px 16px;flex:1;overflow-y:auto;-ms-overflow-style:none;scrollbar-width:none;-webkit-overflow-scrolling:touch}
.glist::-webkit-scrollbar{display:none}
.grow{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;margin-bottom:4px;animation:fadeUp .25s ease both}
.grow:nth-child(even){background:#161c2e66}
.gnum{color:var(--tx2);font-size:11px;font-weight:700;width:22px;flex-shrink:0}
.gdigs{display:flex;gap:4px;flex-shrink:0}
.gdig{width:34px;height:38px;display:flex;align-items:center;justify-content:center;background:var(--s3);border:1.5px solid var(--bdr);border-radius:8px;font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700;transition:all .15s}
.gfb{display:flex;gap:5px;margin-left:auto;flex-wrap:wrap;justify-content:flex-end}
.badge{padding:3px 9px;border-radius:20px;font-size:12px;font-weight:700;white-space:nowrap}
.b-ok{background:#10b98118;color:var(--ok)}.b-w{background:#f59e0b18;color:var(--warn)}.b-no{background:#ef444418;color:var(--bad)}
.b-win{background:var(--ok);color:#000;font-weight:800;padding:4px 14px}
.b-wait{color:var(--tx2);font-size:12px;font-style:italic}

.fbp{background:var(--s2);border-radius:16px;padding:16px;border:1.5px solid #f472b644;margin:12px 0;animation:slideUp .3s ease both}
.fbguess{font-family:'JetBrains Mono',monospace;font-size:28px;letter-spacing:10px;text-align:center;color:var(--tx);font-weight:800;margin-bottom:14px}
.fbrow{display:flex;align-items:center;gap:6px;margin-bottom:10px;flex-wrap:wrap}
.fblbl{font-size:12px;font-weight:700;min-width:95px;flex-shrink:0}
.fbn{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;font-family:'JetBrains Mono',monospace;cursor:pointer;transition:all .15s cubic-bezier(.25,.46,.45,.94);border:1.5px solid var(--bdr);background:0 0;color:var(--tx2)}
.fbn:active{transform:scale(.9)}
.fbn.on{border-color:var(--acc);background:#b4530920;color:var(--acc);transform:scale(1.1);box-shadow:0 0 8px #f59e0b33}
.fbacts{display:flex;gap:8px;margin-top:12px}
.fbacts .btn{flex:1}

.actbar{position:sticky;bottom:0;background:rgba(15,19,32,.9);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border-top:1px solid var(--bdr);padding:12px 16px;padding-bottom:max(12px,var(--safe-bottom));z-index:100}
.ginrow{display:flex;gap:8px;align-items:center}
.ginrow .dig-inp{font-size:22px;letter-spacing:10px;padding:12px 16px}
.ginrow .btn{width:auto;flex-shrink:0;padding:14px 20px}

.rev-box{text-align:center;padding:14px 20px;background:#b4530920;border:2px solid var(--acc);border-radius:12px;margin:16px 0}
.rev-lbl{font-size:10px;color:var(--tx2);text-transform:uppercase;letter-spacing:1px;font-weight:700;margin-bottom:4px}

.label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--tx2);margin-bottom:8px}
.divider{display:flex;align-items:center;gap:12px;color:var(--tx2);font-size:12px;margin:18px 0;font-weight:600}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--bdr)}
.error{color:var(--bad);font-size:13px;text-align:center;margin-top:8px;animation:fadeUp .2s ease}
.pdot{width:10px;height:10px;border-radius:50%;background:var(--acc);animation:pulse 1.4s ease-in-out infinite;margin:0 auto}

.overlay{position:fixed;inset:0;background:rgba(6,8,15,.92);display:flex;align-items:center;justify-content:center;z-index:200;animation:fadeUp .3s ease;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
.wcard{text-align:center;padding:40px 32px;max-width:360px;width:100%}

.glayout{display:flex;flex-direction:column;min-height:100dvh}

.copied-toast{position:fixed;top:calc(20px + var(--safe-top));left:50%;transform:translateX(-50%);background:var(--ok);color:#000;padding:8px 20px;border-radius:10px;font-size:14px;font-weight:700;z-index:999;animation:fadeUp .3s ease both}

@keyframes reminderCircleIn{0%{opacity:0;transform:scale(0.3)}60%{transform:scale(1.08)}100%{opacity:1;transform:scale(1)}}
@keyframes reminderGlow{0%,100%{box-shadow:0 0 0 0 rgba(129,140,248,.25),0 0 40px rgba(129,140,248,.12)}50%{box-shadow:0 0 0 12px rgba(129,140,248,.08),0 0 56px rgba(129,140,248,.2)}}
@keyframes reminderFadeOut{0%{opacity:1;transform:scale(1)}100%{opacity:0;transform:scale(0.92)}}
.make-guess-reminder{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:250;pointer-events:none;animation:fadeUp .2s ease both}
.make-guess-reminder .reminder-circle{width:min(200px,72vw);height:min(200px,72vw);max-width:220px;max-height:220px;border-radius:50%;background:linear-gradient(165deg,var(--s1) 0%,var(--s2) 100%);border:2px solid rgba(129,140,248,.5);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;text-align:center;box-shadow:0 0 0 0 rgba(129,140,248,.2),0 0 40px rgba(129,140,248,.1),inset 0 1px 0 rgba(255,255,255,.06);animation:reminderCircleIn .45s cubic-bezier(.34,1.56,.64,1) both,reminderGlow 2s ease-in-out .3s infinite}
.make-guess-reminder .reminder-circle .reminder-msg{font-size:15px;font-weight:800;color:var(--p1);margin:0;line-height:1.35;letter-spacing:-0.3px}
.make-guess-reminder .reminder-circle .reminder-sub{font-size:12px;color:var(--tx2);margin-top:8px;font-weight:600;line-height:1.3}

.conn-status{position:fixed;bottom:calc(8px + var(--safe-bottom));right:8px;padding:4px 10px;border-radius:8px;font-size:11px;font-weight:600;z-index:300;pointer-events:none}
.conn-ok{background:#10b98133;color:var(--ok)}
.conn-err{background:#ef444433;color:var(--bad)}

/* Winner confetti particles */
@keyframes confetti-fall{
  0%{transform:translateY(-10px) rotate(0deg);opacity:1}
  100%{transform:translateY(100vh) rotate(720deg);opacity:0}
}
.confetti{position:fixed;width:8px;height:8px;border-radius:2px;z-index:201;pointer-events:none;animation:confetti-fall 3s ease-in forwards}

@media(max-width:400px){
  .gdig{width:28px;height:32px;font-size:15px}
  .dig-inp{font-size:22px;letter-spacing:10px}
  .my-secret{font-size:20px;letter-spacing:6px}
  .badge{font-size:11px;padding:2px 7px}
  .card{padding:22px 18px}
  .code{font-size:30px;letter-spacing:8px}
  .orbit{inset:-20px}.orbit-2{inset:-35px}
}
@media(max-width:340px){
  .card{padding:18px 14px}
  .chip{padding:12px 0;font-size:18px}
  .btn{padding:12px 18px;font-size:14px}
  .home-title{letter-spacing:-1px}
}
@media(min-width:600px){
  .screen{padding:32px 24px;padding-top:calc(32px + var(--safe-top))}
  .card-home{padding:36px 32px;border-radius:24px}
  .how-to-play{padding:20px 28px;border-radius:18px}
}
@media(min-width:768px){
  .screen{padding:48px 32px}
  .card-home{max-width:480px;padding:40px 36px}
  .how-to-play{max-width:480px}
}
.chat-reactions{display:flex;gap:4px;flex-wrap:wrap;margin-top:4px}
.chat-reaction{display:inline-flex;align-items:center;gap:2px;padding:2px 8px;border-radius:12px;font-size:13px;cursor:pointer;border:1px solid var(--bdr);background:var(--s2);transition:all .15s}
.chat-reaction.mine-react{border-color:var(--p1);background:#818cf818}
.chat-reaction:active{transform:scale(.9)}
.react-row{display:flex;gap:2px;margin-top:4px;flex-wrap:wrap}
.react-emoji-btn{background:none;border:none;font-size:18px;cursor:pointer;padding:3px;border-radius:8px;transition:all .15s;opacity:.7}
.react-emoji-btn:active{transform:scale(.8);opacity:1}
.react-toggle{background:none;border:none;cursor:pointer;font-size:12px;color:var(--tx2);margin-left:8px;opacity:.4;transition:opacity .15s;padding:0}
.react-toggle:active{opacity:1}
</style>
</head>
<body>
<div id="app"></div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

// ── Capacitor Native Plugins ──
let Haptics, StatusBar, SplashScreen, Keyboard;
let isNative = false;

async function initCapacitor() {
  try {
    const cap = await import('https://unpkg.com/@anthropic-ai/capacitor-bridge@latest/dist/esm/index.js').catch(() => null);
    // Try loading from Capacitor runtime (injected in native builds)
    if (window.Capacitor) {
      isNative = true;
      try {
        const hap = await import('@capacitor/haptics');
        Haptics = hap.Haptics;
      } catch(e) {}
      try {
        const sb = await import('@capacitor/status-bar');
        StatusBar = sb.StatusBar;
        await StatusBar.setStyle({ style: 'DARK' });
        await StatusBar.setBackgroundColor({ color: '#06080f' });
      } catch(e) {}
      try {
        const ss = await import('@capacitor/splash-screen');
        SplashScreen = ss.SplashScreen;
        await SplashScreen.hide();
      } catch(e) {}
      try {
        const kb = await import('@capacitor/keyboard');
        Keyboard = kb.Keyboard;
      } catch(e) {}
    }
  } catch(e) {
    console.log('Running in web mode');
  }
}

// Haptic helpers
function hapticLight() {
  if (Haptics) Haptics.impact({ style: 'LIGHT' }).catch(() => {});
}
function hapticMedium() {
  if (Haptics) Haptics.impact({ style: 'MEDIUM' }).catch(() => {});
}
function hapticHeavy() {
  if (Haptics) Haptics.impact({ style: 'HEAVY' }).catch(() => {});
}
function hapticSuccess() {
  if (Haptics) Haptics.notification({ type: 'SUCCESS' }).catch(() => {});
}
function hapticError() {
  if (Haptics) Haptics.notification({ type: 'ERROR' }).catch(() => {});
}

initCapacitor();

const firebaseConfig = {
  apiKey: "AIzaSyDxwgjrwYFWt9alVan9SggLMb64d_SCUms",
  authDomain: "praizandzikky.firebaseapp.com",
  databaseURL: "https://praizandzikky-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "praizandzikky",
  storageBucket: "praizandzikky.firebasestorage.app",
  messagingSenderId: "865597201878",
  appId: "1:865597201878:web:a8ddca393afe6867141877",
  measurementId: "G-XQ223KRGCY"
};

let db, fbOk = false, unsub = null;
try {
  const app = initializeApp(firebaseConfig);
  db = getDatabase(app);
  fbOk = true;
  console.log('Firebase connected');
} catch(e) {
  console.error('Firebase init failed:', e);
}

// ── DB Layer ──
const DB = {
  async write(id, data) {
    if (!fbOk) throw new Error('Firebase not connected');
    await set(ref(db, 'games/' + id), data);
  },
  async read(id) {
    if (!fbOk) throw new Error('Firebase not connected');
    const s = await get(ref(db, 'games/' + id));
    return s.exists() ? s.val() : null;
  },
  listen(id, cb) {
    this.stop();
    if (!fbOk) return;
    unsub = onValue(ref(db, 'games/' + id), s => { if(s.exists()) cb(s.val()); });
  },
  stop() { if(unsub){unsub();unsub=null;} }
};

// ── State ──
let S = {
  scr:'home', gid:'', join:'', name:localStorage.getItem('nd_name')||'',
  role:0, digits:4, secret:'', guess:'', tab:'my',
  revealed:false, opRev:false, fbP:0, fbN:0,
  err:'', G:null, showWin:false, showMakeGuessReminder:false, loading:false,
  chatDraft:'', chatLastSeenCount:0, reactionPickerIdx:null
};

let renderQueued = false;
const TYPING_KEYS = ['name','join','secret','guess','chatDraft'];
function up(o) {
  Object.assign(S, o);
  if (o.name !== undefined) localStorage.setItem('nd_name', S.name);
  const onlyTyping = Object.keys(o).every(k => TYPING_KEYS.includes(k));
  if (onlyTyping && Object.keys(o).length > 0) return;
  if (!renderQueued) {
    renderQueued = true;
    requestAnimationFrame(() => { renderQueued = false; render(); });
  }
}

const me = () => S.G ? (S.role===1 ? S.G.player1 : S.G.player2) : null;
const opp = () => S.G ? (S.role===1 ? S.G.player2 : S.G.player1) : null;

let guessReminderInterval = null;
let feedbackBeepInterval = null;

// ── Game Actions ──
function getHomeInputs() {
  const nameEl = document.getElementById('name-inp');
  const joinEl = document.getElementById('join-inp');
  return { name: (nameEl?.value ?? '').trim(), join: (joinEl?.value ?? '').trim().toUpperCase() };
}

async function create() {
  const { name } = getHomeInputs();
  if (!name) { hapticError(); up({err:'Enter your name!'}); return; }
  if (!fbOk) { up({err:'Firebase not connected. Check config.'}); return; }
  hapticMedium();
  up({loading:true, err:'', name});
  try {
    const id = Math.random().toString(36).substring(2,8).toUpperCase();
    const G = {
      digits: S.digits,
      player1: { name, secret: '', guesses: false, revealed: false },
      player2: false,
      currentTurn: 1, status: 'waiting', winner: 0, ts: Date.now()
    };
    await DB.write(id, G);
    hapticSuccess();
    up({gid:id, role:1, G, scr:'waiting', loading:false});
    DB.listen(id, onGameUpdate);
  } catch(e) {
    hapticError();
    up({err:'Failed to create game: '+e.message, loading:false});
  }
}

async function join() {
  const { name, join: joinCode } = getHomeInputs();
  if (!name) { hapticError(); up({err:'Enter your name!'}); return; }
  if (!joinCode) { hapticError(); up({err:'Enter game code!'}); return; }
  if (!fbOk) { up({err:'Firebase not connected. Check config.'}); return; }
  hapticMedium();
  up({loading:true, err:'', name, join: joinCode});
  try {
    const id = joinCode;
    const G = await DB.read(id);
    if (!G) { hapticError(); up({err:'Game not found! Double-check the code.', loading:false}); return; }
    if (G.player2) { hapticError(); up({err:'Game is already full!', loading:false}); return; }
    G.player2 = { name, secret: '', guesses: false, revealed: false };
    G.status = 'setting_secrets';
    await DB.write(id, G);
    hapticSuccess();
    up({gid:id, role:2, digits:G.digits, G, scr:'set_secret', loading:false, err:''});
    DB.listen(id, onGameUpdate);
  } catch(e) {
    hapticError();
    up({err:'Failed to join: '+e.message, loading:false});
  }
}

function onGameUpdate(G) {
  if (!G) return;
  const u = {G};
  if (S.scr==='waiting' && G.player2) { u.scr = 'set_secret'; hapticMedium(); }
  if (S.scr==='waiting_secret' && G.status==='playing') { u.scr='playing'; u.tab='my'; hapticSuccess(); }
  if ((S.scr==='playing'||S.showWin) && G.status==='setting_secrets') { u.scr='set_secret'; u.showWin=false; }
  const o = S.role===1 ? G.player2 : G.player1;
  if (o && S.scr==='playing') {
    const gs = o.guesses ? Object.values(o.guesses) : [];
    const last = gs[gs.length-1];
    if (last && !last.feedback) {
      if (S.tab !== 'their') { u.tab = 'their'; hapticHeavy(); }
      if (!feedbackBeepInterval) startFeedbackBeep();
    } else { stopFeedbackBeep(); }
  }
  if (o?.revealed) u.opRev = true;
  if (G.status==='finished' && !S.showWin) { u.showWin = true; hapticHeavy(); }
  // Chat: play inbox sound when new message from opponent and user is not on Chat tab
  const msgs = G.messages || [];
  const prevLen = (S.G && S.G.messages) ? S.G.messages.length : 0;
  if (S.scr==='playing') {
    if (S.tab === 'chat') u.chatLastSeenCount = msgs.length;
    else if (msgs.length > (S.chatLastSeenCount || prevLen)) {
      const lastMsg = msgs[msgs.length - 1];
      if (lastMsg && lastMsg.from !== S.role) {
        playChatInboxSound();
      }
    }
  }
  up(u);
}

async function lockSecret() {
  if (S.secret.length !== S.digits) { hapticError(); up({err:`Need ${S.digits} digits!`}); return; }
  hapticMedium();
  up({loading:true, err:''});
  try {
    const G = await DB.read(S.gid);
    const k = S.role===1 ? 'player1' : 'player2';
    G[k].secret = S.secret;
    const otherKey = S.role===1 ? 'player2' : 'player1';
    if (G[otherKey] && G[otherKey].secret) G.status = 'playing';
    await DB.write(S.gid, G);
    hapticSuccess();
    up(G.status==='playing'
      ? {G, scr:'playing', tab:'my', loading:false, err:''}
      : {G, scr:'waiting_secret', loading:false, err:''});
  } catch(e) { hapticError(); up({err:'Error: '+e.message, loading:false}); }
}

async function sendGuess() {
  if (S.guess.length !== S.digits) { hapticError(); up({err:`Need ${S.digits} digits!`}); return; }
  hapticMedium();
  up({loading:true, err:''});
  try {
    const G = await DB.read(S.gid);
    const k = S.role===1 ? 'player1' : 'player2';
    let guesses = G[k].guesses ? (typeof G[k].guesses === 'object' ? Object.values(G[k].guesses) : []) : [];
    guesses.push({ value: S.guess, feedback: false });
    G[k].guesses = guesses;
    G.currentTurn = S.role===1 ? 2 : 1;
    await DB.write(S.gid, G);
    hapticSuccess();
    stopGuessReminderBeep();
    up({G, guess:'', loading:false, err:'', showMakeGuessReminder:false});
  } catch(e) { hapticError(); up({err:'Error: '+e.message, loading:false}); }
}

async function sendFb() {
  hapticMedium();
  up({loading:true});
  try {
    const G = await DB.read(S.gid);
    const ok = S.role===1 ? 'player2' : 'player1';
    let guesses = G[ok].guesses ? Object.values(G[ok].guesses) : [];
    const last = guesses[guesses.length-1];
    if (last && !last.feedback) {
      last.feedback = { correctPos: S.fbP, correctNum: S.fbN };
      if (S.fbP === S.digits) { G.status='finished'; G.winner = S.role===1?2:1; }
      G.currentTurn = S.role;
    }
    G[ok].guesses = guesses;
    await DB.write(S.gid, G);
    if (S.fbP === S.digits) hapticHeavy(); else hapticSuccess();
    const isGameOver = G.status === 'finished';
    stopFeedbackBeep();
    up({G, fbP:0, fbN:0, tab:'my', loading:false, showWin:isGameOver, showMakeGuessReminder: !isGameOver});
    if (!isGameOver) {
      playReminderBeep();
      startGuessReminderBeep();
    }
  } catch(e) { hapticError(); up({err:'Error: '+e.message, loading:false}); }
}

function allWrong() { hapticLight(); S.fbP=0; S.fbN=0; sendFb(); }
function allCorrect() { hapticHeavy(); S.fbP=S.digits; S.fbN=0; sendFb(); }

async function doReveal() {
  hapticMedium();
  try {
    const G = await DB.read(S.gid);
    const k = S.role===1 ? 'player1' : 'player2';
    G[k].revealed = true;
    await DB.write(S.gid, G);
    up({G, revealed:true});
  } catch(e) { console.error(e); }
}

function getMessages() {
  if (!S.G || !S.G.messages) return [];
  return Array.isArray(S.G.messages) ? S.G.messages : Object.values(S.G.messages);
}

async function sendChat() {
  const text = (S.chatDraft || '').trim();
  if (!text || !S.gid) return;
  hapticLight();
  up({loading:true});
  try {
    const G = await DB.read(S.gid);
    G.messages = G.messages || [];
    G.messages.push({ text, from: S.role, ts: Date.now() });
    await DB.write(S.gid, G);
    up({G, chatDraft:'', loading:false});
  } catch(e) {
    hapticError();
    up({err:'Failed to send', loading:false});
  }
}

const REACTION_EMOJIS = ['\u{1F44D}','\u2764\uFE0F','\u{1F602}','\u{1F62E}','\u{1F622}','\u{1F525}'];

async function sendReaction(msgIdx, emoji) {
  if (!S.gid) return;
  hapticLight();
  try {
    const G = await DB.read(S.gid);
    if (!G.messages || !G.messages[msgIdx]) return;
    const msg = G.messages[msgIdx];
    if (!msg.reactions) msg.reactions = {};
    if (!msg.reactions[emoji]) msg.reactions[emoji] = [];
    const idx = msg.reactions[emoji].indexOf(S.role);
    if (idx >= 0) msg.reactions[emoji].splice(idx, 1);
    else msg.reactions[emoji].push(S.role);
    if (msg.reactions[emoji].length === 0) delete msg.reactions[emoji];
    await DB.write(S.gid, G);
    up({G, reactionPickerIdx: null});
  } catch(e) { console.error(e); }
}

// Short inbox/message-received sound when new chat message and user not on Chat tab
function playChatInboxSound() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const playTone = (freq, startTime, duration, vol) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.value = freq;
      osc.type = 'sine';
      gain.gain.setValueAtTime(0, startTime);
      gain.gain.linearRampToValueAtTime(vol, startTime + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
      osc.start(startTime);
      osc.stop(startTime + duration);
    };
    playTone(587.33, ctx.currentTime, 0.1, 0.15);       // D5
    playTone(783.99, ctx.currentTime + 0.08, 0.12, 0.12); // G5 — soft double tap
  } catch (e) { /* ignore */ }
}

function restart() { DB.stop(); stopGuessReminderBeep(); stopFeedbackBeep(); Object.assign(S,{scr:'home',gid:'',join:'',role:0,digits:4,secret:'',guess:'',tab:'my',revealed:false,opRev:false,fbP:0,fbN:0,err:'',G:null,showWin:false,showMakeGuessReminder:false,loading:false,chatDraft:'',chatLastSeenCount:0,reactionPickerIdx:null}); render(); }

async function playAgain() {
  if (!S.G || !fbOk) return;
  hapticMedium();
  up({loading:true, showWin:false});
  try {
    const G = {
      ...S.G,
      player1: { ...S.G.player1, secret: '', guesses: false, revealed: false },
      player2: S.G.player2 ? { ...S.G.player2, secret: '', guesses: false, revealed: false } : false,
      status: 'setting_secrets',
      currentTurn: 1,
      winner: 0,
      ts: Date.now()
    };
    await DB.write(S.gid, G);
    hapticSuccess();
    up({G, secret:'', guess:'', tab:'my', revealed:false, opRev:false, fbP:0, fbN:0, scr:'set_secret', loading:false});
  } catch(e) {
    hapticError();
    up({err:'Failed to rematch: '+e.message, loading:false});
  }
}

function toast(msg) {
  const t=document.createElement('div'); t.className='copied-toast'; t.textContent=msg;
  document.body.appendChild(t); setTimeout(()=>t.remove(),1500);
}

// iPhone-style short chime — used after giving feedback to remind user to make their guess
function playReminderBeep() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const playTone = (freq, startTime, duration) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.value = freq;
      osc.type = 'sine';
      gain.gain.setValueAtTime(0, startTime);
      gain.gain.linearRampToValueAtTime(0.14, startTime + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
      osc.start(startTime);
      osc.stop(startTime + duration);
    };
    playTone(523.25, ctx.currentTime, 0.12);       // C5
    playTone(659.25, ctx.currentTime + 0.1, 0.14); // E5 — short two-tone chime
  } catch (e) { /* ignore if audio not allowed */ }
}

function startGuessReminderBeep() {
  stopGuessReminderBeep();
  guessReminderInterval = setInterval(() => {
    if (S.showMakeGuessReminder) playReminderBeep();
    else stopGuessReminderBeep();
  }, 5000);
}

function stopGuessReminderBeep() {
  if (guessReminderInterval) { clearInterval(guessReminderInterval); guessReminderInterval = null; }
}

function startFeedbackBeep() {
  stopFeedbackBeep();
  playReminderBeep();
  feedbackBeepInterval = setInterval(() => playReminderBeep(), 4000);
}

function stopFeedbackBeep() {
  if (feedbackBeepInterval) { clearInterval(feedbackBeepInterval); feedbackBeepInterval = null; }
}

function spawnConfetti() {
  const colors = ['#818cf8','#f472b6','#f59e0b','#10b981','#ef4444','#e8ecf4'];
  for (let i = 0; i < 40; i++) {
    const c = document.createElement('div');
    c.className = 'confetti';
    c.style.left = Math.random() * 100 + 'vw';
    c.style.top = '-10px';
    c.style.background = colors[Math.floor(Math.random() * colors.length)];
    c.style.animationDelay = Math.random() * 2 + 's';
    c.style.animationDuration = (2 + Math.random() * 2) + 's';
    c.style.width = (6 + Math.random() * 6) + 'px';
    c.style.height = (6 + Math.random() * 6) + 'px';
    document.body.appendChild(c);
    setTimeout(() => c.remove(), 5000);
  }
}

function getGuesses(player) {
  if (!player || !player.guesses) return [];
  if (Array.isArray(player.guesses)) return player.guesses;
  if (typeof player.guesses === 'object') return Object.values(player.guesses);
  return [];
}

// ── DOM ──
function h(tag,a,...ch){
  const el=document.createElement(tag);
  if(a)Object.entries(a).forEach(([k,v])=>{
    if(k==='style'&&typeof v==='object')Object.assign(el.style,v);
    else if(k.startsWith('on'))el.addEventListener(k.slice(2).toLowerCase(),v);
    else if(k==='className')el.className=v;
    else if((k==='value'||k==='defaultValue')&&(tag==='input'||tag==='textarea'))el.value=v??'';
    else if(k==='disabled'){if(v)el.setAttribute('disabled','');else el.removeAttribute('disabled');}
    else el.setAttribute(k,v);
  });
  ch.flat().forEach(c=>{if(c!=null)el.appendChild(typeof c==='string'?document.createTextNode(c):c);});
  return el;
}

function gRow(g,i){
  const ds=g.value.split(''), fb=g.feedback, fbs=[];
  if(fb && fb.correctPos !== undefined){
    if(fb.correctPos===ds.length) fbs.push(h('span',{className:'badge b-win'},'CRACKED!'));
    else{
      fbs.push(h('span',{className:'badge b-ok'},`${fb.correctPos}`));
      fbs.push(h('span',{className:'badge b-w'},`~ ${fb.correctNum}`));
      fbs.push(h('span',{className:'badge b-no'},`${ds.length-fb.correctPos-fb.correctNum}`));
    }
  } else fbs.push(h('span',{className:'b-wait'},'awaiting feedback'));
  return h('div',{className:'grow'},
    h('span',{className:'gnum'},`${i+1}`),
    h('div',{className:'gdigs'},...ds.map(d=>h('div',{className:'gdig'},d))),
    h('div',{className:'gfb'},...fbs));
}

function fbPanel(){
  const o=opp(); if(!o)return h('div');
  const gs=getGuesses(o), last=gs[gs.length-1];
  if(!last||last.feedback)return h('div');
  const nb=(max,cur,fn)=>Array.from({length:max+1},(_,i)=>
    h('button',{className:`fbn ${cur===i?'on':''}`,onClick:()=>{hapticLight();fn(i);render();}},`${i}`));
  return h('div',{className:'fbp'},
    h('div',{style:{fontSize:'13px',fontWeight:'700',color:'var(--p2)',marginBottom:'6px'}},`${o.name} guessed:`),
    h('div',{className:'fbguess'},last.value),
    h('div',{className:'fbrow'},
      h('span',{className:'fblbl',style:{color:'var(--ok)'}},'Right spot'),
      ...nb(S.digits,S.fbP,v=>{S.fbP=v;if(S.fbP+S.fbN>S.digits)S.fbN=S.digits-S.fbP;})),
    h('div',{className:'fbrow'},
      h('span',{className:'fblbl',style:{color:'var(--warn)'}},'Wrong spot'),
      ...nb(S.digits-S.fbP,S.fbN,v=>{S.fbN=v;})),
    h('div',{className:'fbacts'},
      h('button',{className:'btn btn-sm btn-bad',onClick:allWrong},'All Wrong'),
      h('button',{className:'btn btn-sm btn-ok',onClick:allCorrect},'All Correct'),
      h('button',{className:'btn btn-sm btn-acc',onClick:sendFb},'Submit')));
}

// ── Render ──
function render(){
  const root=document.getElementById('app');
  root.innerHTML='';

  const conn = h('div',{className:`conn-status ${fbOk?'conn-ok':'conn-err'}`},
    fbOk?'Online':'Offline');
  root.appendChild(conn);

  // HOME
  if(S.scr==='home'){
    // Animated background with floating numbers
    const bg = h('div',{className:'home-bg'});
    const floatNums = ['0','1','2','3','4','5','6','7','8','9','?'];
    floatNums.forEach((n,i) => {
      const size = 20 + Math.random() * 40;
      bg.appendChild(h('div',{className:'float-num',style:{
        fontSize:size+'px',
        left:(5 + i * 8.5)+'%',
        top:(10 + Math.random() * 75)+'%',
        animation:`float ${6 + Math.random()*6}s ease-in-out ${Math.random()*4}s infinite`,
        opacity: .03 + Math.random() * .04
      }},n));
    });
    root.appendChild(bg);

    root.appendChild(h('div',{className:'screen',style:{position:'relative',zIndex:'1'}},
      // Hero section with orbiting decorations
      h('div',{className:'stagger-1',style:{textAlign:'center',marginBottom:'32px'}},
        h('div',{className:'title-wrap'},
          h('div',{className:'orbit'}),
          h('div',{className:'orbit-2'}),
          h('div',{className:'home-title'},
            h('span',{style:{color:'var(--p1)'}},'NUM'),
            h('span',{className:'dot'},'●'),
            h('span',{style:{color:'var(--p2)'}},'DUEL'))),
        h('p',{className:'home-subtitle'},'The number guessing showdown')),

      // Main card with staggered entrance
      h('div',{className:'card card-home stagger-2'},
        h('div',{className:'label'},'Your Name'),
        h('input',{id:'name-inp',className:'inp',placeholder:'Enter your name',value:S.name,autocomplete:'off',autocorrect:'off',spellcheck:'false'}),
        h('div',{className:'label',style:{marginTop:'20px'}},'Number of Digits'),
        h('div',{className:'chips'},
          ...[3,4,5,6].map(n=>h('button',{className:`chip ${S.digits===n?'on':''}`,onClick:()=>{
            hapticLight();
            const {name,join}=getHomeInputs();
            up({digits:n,name,join});
          }},`${n}`))),
        h('button',{className:'btn btn-go',style:{marginTop:'20px'},disabled:S.loading,onClick:create},
          S.loading?'Creating...':'Create New Game'),
        h('div',{className:'divider'},'OR JOIN A GAME'),
        h('div',{style:{display:'flex',gap:'8px'}},
          h('input',{id:'join-inp',className:'inp mono',style:{letterSpacing:'6px',textAlign:'center',textTransform:'uppercase',fontSize:'18px'},
            placeholder:'GAME CODE',maxLength:'6',value:S.join,autocomplete:'off',autocorrect:'off',autocapitalize:'characters',spellcheck:'false',
            onKeydown:e=>{if(e.key==='Enter')join();}}),
          h('button',{className:'btn btn-out',style:{width:'auto',flexShrink:'0'},disabled:S.loading,onClick:join},
            S.loading?'...':'Join')),
        S.err?h('div',{className:'error'},S.err):null),

      // How to play with gradient border
      h('div',{className:'how-to-play'},
        h('div',{style:{color:'var(--tx2)',fontSize:'13px',lineHeight:'1.7',textAlign:'center'}},
          h('strong',{style:{color:'var(--tx)',fontSize:'14px'}},'How to play'),
          h('br'),
          'Each player picks a secret number. Take turns guessing each other\'s number. After each guess, give feedback: how many digits are correct + right position, correct but wrong position, or totally wrong. First to crack the code wins!'))));
    return;
  }

  // WAITING
  if(S.scr==='waiting'){
    root.appendChild(h('div',{className:'screen'},
      h('div',{className:'card fade-up',style:{textAlign:'center'}},
        h('div',{className:'code',onClick:()=>{hapticLight();navigator.clipboard?.writeText(S.gid);toast('Code copied!');}},S.gid),
        h('p',{style:{color:'var(--tx2)',fontSize:'14px',marginTop:'14px'}},'Share this code with your partner'),
        h('p',{style:{color:'var(--tx2)',fontSize:'13px',marginTop:'4px'}},'Tap code to copy'),
        h('div',{style:{marginTop:'20px'}},h('div',{className:'pdot'})),
        h('p',{style:{color:'var(--tx2)',fontSize:'13px',marginTop:'10px'}},'Waiting for them to join...'),
        h('p',{style:{fontSize:'12px',color:'var(--tx2)',marginTop:'16px'}},`${S.digits}-digit game`),
        h('button',{className:'btn btn-out',style:{marginTop:'20px'},onClick:restart},'Cancel'))));
    return;
  }

  // SET SECRET
  if(S.scr==='set_secret'){
    const o=opp();
    root.appendChild(h('div',{className:'screen'},
      h('div',{className:'card slide-up',style:{textAlign:'center'}},
        h('div',{style:{fontSize:'36px',marginBottom:'8px'}},''),
        h('h2',{style:{fontSize:'22px',fontWeight:'800',marginBottom:'6px'}},'Set Your Secret'),
        h('p',{style:{color:'var(--tx2)',fontSize:'14px',marginBottom:'24px'}},
          `Pick a ${S.digits}-digit number for ${o?.name||'your opponent'} to guess`),
        h('input',{className:'inp dig-inp',type:'tel',maxLength:S.digits,placeholder:'\u2022'.repeat(S.digits),value:S.secret,
          onInput:e=>{const v=e.target.value.replace(/[^0-9]/g,'');if(v.length<=S.digits){hapticLight();up({secret:v});const b=document.getElementById('lock-secret-btn');if(b)b.disabled=v.length!==S.digits||S.loading;}},
          onKeydown:e=>{if(e.key==='Enter'&&S.secret.length===S.digits)lockSecret();}}),
        h('button',{id:'lock-secret-btn',className:'btn btn-go',style:{marginTop:'16px'},disabled:S.secret.length!==S.digits||S.loading,onClick:lockSecret},
          S.loading?'Locking...':'Lock In Secret'),
        S.err?h('div',{className:'error'},S.err):null)));
    setTimeout(()=>{const i=root.querySelector('.dig-inp');if(i)i.focus();},100);
    return;
  }

  // WAITING FOR OTHER SECRET
  if(S.scr==='waiting_secret'){
    const o=opp();
    root.appendChild(h('div',{className:'screen'},
      h('div',{className:'card slide-up',style:{textAlign:'center'}},
        h('div',{style:{fontSize:'36px',marginBottom:'8px'}},''),
        h('h2',{style:{fontSize:'20px',fontWeight:'800',marginBottom:'8px'}},'Your Secret is Locked!'),
        h('p',{style:{color:'var(--tx2)',fontSize:'14px'}},`Waiting for ${o?.name||'opponent'} to set their number...`),
        h('div',{style:{marginTop:'20px'}},h('div',{className:'pdot'})))));
    return;
  }

  // PLAYING
  if(S.scr==='playing'&&S.G){
    const m=me(), o=opp();
    const mG=getGuesses(m), oG=getGuesses(o);
    const lastO=oG[oG.length-1];
    const needFb=lastO && !lastO.feedback;
    const myT=S.G.currentTurn===S.role;
    const over=S.G.status==='finished';
    const didIWin = S.G.winner === S.role;

    const lay=h('div',{className:'glayout'});

    lay.appendChild(h('div',{className:'topbar'},
      h('div',{},
        h('div',{className:'my-secret-lbl'},'Your Secret'),
        h('div',{className:'my-secret'},m?.secret||'????')),
      h('div',{style:{display:'flex',gap:'8px',alignItems:'center'}},
        !S.revealed
          ?h('button',{className:'btn btn-sm btn-out',style:{width:'auto'},onClick:doReveal},'Reveal')
          :h('span',{style:{fontSize:'12px',color:'var(--ok)',fontWeight:'700'}},'Revealed'),
        h('button',{className:'btn btn-sm btn-out',style:{width:'auto',color:'var(--bad)',borderColor:'var(--bad)'},onClick:restart},'Exit'))));

    let sc='wait',st=`Waiting for ${o?.name}...`;
    if(over){sc='done';st=didIWin?`You cracked it in ${mG.length} guesses!`:`${o?.name} cracked yours in ${oG.length} guesses`;}
    else if(needFb){sc='fb';st=`${o?.name} guessed \u2014 give feedback!`;}
    else if(myT){sc='go';st='Your turn \u2014 make a guess!';}
    lay.appendChild(h('div',{className:`status ${sc}`},st));

    const msgs = getMessages();
    const unreadChat = msgs.length > (S.chatLastSeenCount || 0);
    const t1=h('button',{className:`tab ${S.tab==='my'?'on':''}`,onClick:()=>{hapticLight();up({tab:'my'});}},`Your Guesses (${mG.length})`);
    const t2=h('button',{className:`tab ${S.tab==='their'?'on':''}`,onClick:()=>{hapticLight();up({tab:'their'});}},`${o?.name||'Them'} (${oG.length})`);
    if(needFb) t2.appendChild(h('span',{className:'dot'}));
    const t3=h('button',{className:`tab tab-chat ${S.tab==='chat'?'on':''}`,onClick:()=>{hapticLight();up({tab:'chat',chatLastSeenCount:msgs.length});}},'Chat');
    if(unreadChat && S.tab!=='chat') t3.appendChild(h('span',{className:'dot'}));
    lay.appendChild(h('div',{className:'tabs'},t1,t2,t3));

    const list=h('div',{className:S.tab==='chat'?'chat-list':'glist'});
    if(S.tab==='chat'){
      if(!msgs.length) list.appendChild(h('div',{style:{textAlign:'center',padding:'32px 20px',color:'var(--tx2)',fontSize:'14px'}},'No messages yet. Say hi!'));
      else msgs.forEach((msg, idx)=>{
        const isMe = msg.from === S.role;
        const name = isMe ? 'You' : (msg.from===1 ? (S.G.player1?.name||'P1') : (S.G.player2?.name||'P2'));
        const msgEl = h('div',{className:`chat-msg ${isMe?'mine':'theirs'}`},
          h('div',{},msg.text),
          h('div',{className:'chat-meta'},
            h('span',{},name),
            h('button',{className:'react-toggle',onClick:e=>{e.stopPropagation();up({reactionPickerIdx:S.reactionPickerIdx===idx?null:idx});}},'+')
          ));
        const reactions = msg.reactions || {};
        const rKeys = Object.keys(reactions).filter(k => reactions[k] && reactions[k].length > 0);
        if (rKeys.length) {
          msgEl.appendChild(h('div',{className:'chat-reactions'},
            ...rKeys.map(em => h('span',{className:`chat-reaction ${reactions[em].includes(S.role)?'mine-react':''}`,
              onClick:()=>sendReaction(idx,em)},`${em} ${reactions[em].length}`))));
        }
        if (S.reactionPickerIdx === idx) {
          msgEl.appendChild(h('div',{className:'react-row'},
            ...REACTION_EMOJIS.map(em => h('button',{className:'react-emoji-btn',onClick:()=>sendReaction(idx,em)},em))));
        }
        list.appendChild(msgEl);
      });
    } else if(S.tab==='my'){
      if(!mG.length) list.appendChild(h('div',{style:{textAlign:'center',padding:'40px 20px',color:'var(--tx2)',fontSize:'14px'}},
        `No guesses yet \u2014 you're guessing ${o?.name}'s number`));
      else mG.forEach((g,i)=>list.appendChild(gRow(g,i)));
      if(S.opRev||over) list.appendChild(h('div',{className:'rev-box'},
        h('div',{className:'rev-lbl'},`${o?.name}'s Secret Was`),h('div',{className:'my-secret'},o?.secret||'???')));
    } else if(S.tab==='their'){
      if(!oG.length) list.appendChild(h('div',{style:{textAlign:'center',padding:'40px 20px',color:'var(--tx2)',fontSize:'14px'}},
        `${o?.name} hasn't guessed yet`));
      else oG.forEach((g,i)=>list.appendChild(gRow(g,i)));
      if(needFb&&!over) list.appendChild(fbPanel());
    }
    lay.appendChild(list);

    if(!over){
      if(S.tab==='chat'){
        lay.appendChild(h('div',{className:'actbar'},
          h('div',{className:'chat-inrow'},
            h('input',{className:'inp',type:'text',placeholder:'Message...',maxLength:500,value:S.chatDraft,
              onInput:e=>{hapticLight();up({chatDraft:e.target.value});const b=document.getElementById('chat-send-btn');if(b)b.disabled=!e.target.value.trim()||S.loading;},
              onKeydown:e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendChat();}}}),
            h('button',{id:'chat-send-btn',className:'btn btn-acc',disabled:!S.chatDraft.trim()||S.loading,onClick:sendChat},S.loading?'...':'Send'))));
      } else if(S.tab==='my'){
        if(myT&&!needFb){
          lay.appendChild(h('div',{className:'actbar'},
            h('div',{className:'ginrow'},
              h('input',{className:'inp dig-inp',type:'tel',maxLength:S.digits,placeholder:'\u2022'.repeat(S.digits),value:S.guess,
                onInput:e=>{const v=e.target.value.replace(/[^0-9]/g,'');if(v.length<=S.digits){hapticLight();if(S.showMakeGuessReminder){stopGuessReminderBeep();up({guess:v,showMakeGuessReminder:false});}else{up({guess:v});}const b=document.getElementById('send-guess-btn');if(b)b.disabled=v.length!==S.digits||S.loading;}},
                onKeydown:e=>{if(e.key==='Enter'&&S.guess.length===S.digits)sendGuess();}}),
              h('button',{id:'send-guess-btn',className:'btn btn-acc',disabled:S.guess.length!==S.digits||S.loading,onClick:sendGuess},
                S.loading?'...':'Go')),
            S.err?h('div',{className:'error'},S.err):null));
        } else if(needFb){
          lay.appendChild(h('div',{className:'actbar'},
            h('div',{style:{textAlign:'center',color:'var(--p2)',fontWeight:'700',fontSize:'14px',cursor:'pointer'},
              onClick:()=>{hapticLight();up({tab:'their'});}},`Tap here to give feedback on ${o?.name}'s guess`)));
        } else {
          lay.appendChild(h('div',{className:'actbar'},
            h('div',{style:{textAlign:'center',color:'var(--tx2)',fontSize:'14px'}},
              `Waiting for ${o?.name} to make a guess...`)));
        }
      }
    } else {
      lay.appendChild(h('div',{className:'actbar'},
        h('button',{className:'btn btn-go',disabled:S.loading,onClick:playAgain},S.loading?'Creating...':'New Game')));
    }

    root.appendChild(lay);

    // Winner overlay
    if(S.showWin){
      if(didIWin) spawnConfetti();
      root.appendChild(h('div',{className:'overlay',onClick:()=>up({showWin:false})},
        h('div',{className:'card wcard pop'},
          h('div',{style:{fontSize:'64px',marginBottom:'16px'}},didIWin?'':''),
          h('div',{style:{fontSize:'28px',fontWeight:'800',color:didIWin?'var(--ok)':'var(--bad)'}},
            didIWin?'You Won!':'They Got It!'),
          h('div',{style:{color:'var(--tx2)',fontSize:'15px',margin:'8px 0 16px'}},
            didIWin?`You cracked ${o?.name}'s number in ${mG.length} guesses!`
              :`${o?.name} cracked your number in ${oG.length} guesses`),
          h('div',{style:{margin:'0 0 28px',textAlign:'center'}},
            h('div',{style:{fontSize:'12px',color:'var(--tx2)',marginBottom:'4px'}},`${o?.name}'s Secret Was`),
            h('div',{style:{fontSize:'24px',fontWeight:'800',letterSpacing:'6px',color:'var(--p1)'}},o?.secret||'???')),
          h('button',{className:'btn btn-go',disabled:S.loading,onClick:e=>{e.stopPropagation();playAgain();}},S.loading?'Creating...':'Play Again'),
          h('button',{className:'btn btn-out',style:{marginTop:'8px'},onClick:e=>{e.stopPropagation();up({showWin:false});}},'View Board'))));
    }

    if(S.showMakeGuessReminder){
      root.appendChild(h('div',{className:'make-guess-reminder'},
        h('div',{className:'reminder-circle'},
          h('p',{className:'reminder-msg'},'Make your own guess now'),
          h('p',{className:'reminder-sub'},'Enter your next guess to crack their number'))));
    }

    const gl=root.querySelector('.glist')||root.querySelector('.chat-list');
    if(gl)setTimeout(()=>gl.scrollTop=gl.scrollHeight,50);
    if(!over&&myT&&!needFb&&S.tab==='my'){
      const gi=root.querySelector('.actbar .dig-inp');
      if(gi)setTimeout(()=>gi.focus(),150);
    }
  }
}

render();
</script>
</body>
</html>
